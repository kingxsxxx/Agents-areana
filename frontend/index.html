<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AGORA AI</title>
  <style>
    :root {
      --bg: #0b1020;
      --bg-card: #121a2f;
      --bg-soft: #1a2542;
      --text: #e7ecff;
      --muted: #9fb0de;
      --line: #2d3a63;
      --accent: #37b7ff;
      --accent-2: #20e3b2;
      --danger: #ff6b6b;
      --warn: #ffbd59;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      background:
        radial-gradient(1200px 700px at 10% -10%, #1d2f58 0%, transparent 60%),
        radial-gradient(900px 600px at 90% -20%, #153654 0%, transparent 55%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .container { max-width: 1080px; margin: 28px auto; padding: 0 16px; }
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
    }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .space { height: 14px; }
    .title { font-size: 28px; font-weight: 800; letter-spacing: 0.5px; margin: 0; }
    .sub { color: var(--muted); margin: 8px 0 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    input, select {
      background: var(--bg-soft);
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      min-width: 0;
    }
    input:focus, select:focus { border-color: var(--accent); }
    button {
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 600;
      color: #04101c;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      cursor: pointer;
    }
    button.secondary {
      color: var(--text);
      background: #1f2b4c;
      border-color: var(--line);
    }
    button.danger {
      color: #2b0d10;
      background: linear-gradient(135deg, #ff8a8a, var(--danger));
    }
    button.warn {
      color: #2b2000;
      background: linear-gradient(135deg, #ffd689, var(--warn));
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: #151f39;
    }
    .list { display: grid; gap: 10px; }
    .item {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      background: rgba(18, 26, 47, 0.8);
    }
    .mono {
      font-family: Consolas, "SFMono-Regular", Menlo, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      background: #0d1530;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      color: #c9d6ff;
    }
    .ok { color: #49d17f; }
    .bad { color: #ff7e8a; }
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="panel">
      <h1 class="title">AGORA AI</h1>
      <p class="sub">正式入口（真实 API 联动）</p>
      <div class="space"></div>
      <div class="row">
        <span>后端状态：</span>
        <strong :class="healthOk ? 'ok' : 'bad'">{{ healthText }}</strong>
      </div>
    </div>

    <div class="space"></div>

    <div v-if="!user" class="panel">
      <div class="row">
        <h3 style="margin:0">{{ mode === 'login' ? '登录' : '注册' }}</h3>
        <button class="secondary" @click="toggleMode">
          {{ mode === 'login' ? '切换到注册' : '切换到登录' }}
        </button>
      </div>
      <div class="space"></div>
      <div class="grid">
        <input v-model="form.username" placeholder="用户名" />
        <input v-model="form.password" type="password" placeholder="密码" />
        <input v-if="mode==='register'" v-model="form.email" placeholder="邮箱" />
      </div>
      <div class="space"></div>
      <div class="row">
        <button @click="submitAuth" :disabled="busy">{{ busy ? '处理中...' : (mode==='login'?'登录':'注册') }}</button>
      </div>
      <div class="space"></div>
      <div class="mono">{{ authResult }}</div>
    </div>

    <div v-else class="grid">
      <div class="panel">
        <div class="row" style="justify-content: space-between;">
          <div>
            <h3 style="margin:0">控制台</h3>
            <p class="sub" style="margin:6px 0 0">当前用户：{{ user.username }}</p>
          </div>
          <button class="danger" @click="logout">退出</button>
        </div>
        <div class="space"></div>
        <div class="row">
          <input v-model="newDebateTitle" placeholder="输入辩题后创建辩论" style="flex:1" />
          <button @click="createDebate" :disabled="busy || !newDebateTitle.trim()">创建</button>
        </div>
        <div class="space"></div>
        <div class="row">
          <button class="secondary" @click="loadDebates" :disabled="busy">刷新辩论列表</button>
          <button class="secondary" @click="loadCurrentUser" :disabled="busy">刷新用户信息</button>
        </div>
        <div class="space"></div>
        <div class="mono">{{ actionResult }}</div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 10px;">辩论列表</h3>
        <div class="list">
          <div v-for="d in debates" :key="d.debate_id || d.id" class="item">
            <div class="row" style="justify-content: space-between;">
              <strong>{{ d.title }}</strong>
              <span class="badge">{{ d.status }}</span>
            </div>
            <div class="space"></div>
            <div class="row">
              <button class="secondary" @click="viewDebate(d)">详情</button>
              <button @click="startDebate(d)">启动</button>
              <button class="warn" @click="pauseDebate(d)">暂停</button>
              <button class="secondary" @click="resumeDebate(d)">恢复</button>
              <button class="danger" @click="stopDebate(d)">结束</button>
            </div>
          </div>
          <div v-if="!debates.length" class="sub">暂无辩论，先创建一个。</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createApp, ref, reactive, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import apiClient, { getErrorMessage } from './js/api.js';

    createApp({
      setup() {
        const mode = ref('login');
        const busy = ref(false);
        const form = reactive({ username: '', password: '', email: '' });
        const user = ref(null);
        const debates = ref([]);
        const newDebateTitle = ref('');
        const healthOk = ref(false);
        const healthText = ref('检查中...');
        const authResult = ref('等待操作...');
        const actionResult = ref('等待操作...');

        const checkHealth = async () => {
          try {
            const r = await fetch('/api/health');
            if (!r.ok) throw new Error('HTTP ' + r.status);
            const data = await r.json();
            healthOk.value = true;
            healthText.value = data.status || 'healthy';
          } catch (e) {
            healthOk.value = false;
            healthText.value = '异常: ' + e.message;
          }
        };

        const loadCurrentUser = async () => {
          try {
            const me = await apiClient.getCurrentUser();
            user.value = me;
          } catch (_) {
            user.value = null;
          }
        };

        const loadDebates = async () => {
          busy.value = true;
          try {
            const list = await apiClient.getDebates();
            debates.value = Array.isArray(list) ? list : [];
            actionResult.value = JSON.stringify({ ok: true, debates: debates.value.length }, null, 2);
          } catch (e) {
            actionResult.value = JSON.stringify({ ok: false, error: getErrorMessage(e) }, null, 2);
          } finally {
            busy.value = false;
          }
        };

        const submitAuth = async () => {
          busy.value = true;
          try {
            let result;
            if (mode.value === 'login') {
              result = await apiClient.login(form.username.trim(), form.password);
            } else {
              result = await apiClient.register(form.username.trim(), form.email.trim(), form.password);
            }
            user.value = result;
            authResult.value = JSON.stringify({ ok: true, mode: mode.value, user: result.username }, null, 2);
            await loadDebates();
          } catch (e) {
            authResult.value = JSON.stringify({ ok: false, error: getErrorMessage(e) }, null, 2);
          } finally {
            busy.value = false;
          }
        };

        const toggleMode = () => {
          mode.value = mode.value === 'login' ? 'register' : 'login';
        };

        const logout = async () => {
          busy.value = true;
          try {
            await apiClient.logout();
          } finally {
            user.value = null;
            debates.value = [];
            busy.value = false;
          }
        };

        const createDebate = async () => {
          busy.value = true;
          try {
            const data = await apiClient.createDebate(newDebateTitle.value.trim());
            newDebateTitle.value = '';
            actionResult.value = JSON.stringify({ ok: true, created: data }, null, 2);
            await loadDebates();
          } catch (e) {
            actionResult.value = JSON.stringify({ ok: false, error: getErrorMessage(e) }, null, 2);
          } finally {
            busy.value = false;
          }
        };

        const runAction = async (fn) => {
          busy.value = true;
          try {
            const res = await fn();
            actionResult.value = JSON.stringify({ ok: true, data: res }, null, 2);
            await loadDebates();
          } catch (e) {
            actionResult.value = JSON.stringify({ ok: false, error: getErrorMessage(e) }, null, 2);
          } finally {
            busy.value = false;
          }
        };

        const debateId = (d) => d.debate_id || d.id;
        const viewDebate = (d) => runAction(() => apiClient.getDebate(debateId(d)));
        const startDebate = (d) => runAction(() => apiClient.startDebate(debateId(d)));
        const pauseDebate = (d) => runAction(() => apiClient.pauseDebate(debateId(d)));
        const resumeDebate = (d) => runAction(() => apiClient.resumeDebate(debateId(d)));
        const stopDebate = (d) => runAction(() => apiClient.stopDebate(debateId(d)));

        onMounted(async () => {
          await checkHealth();
          await loadCurrentUser();
          if (user.value) await loadDebates();
        });

        return {
          mode, busy, form, user, debates, newDebateTitle,
          healthOk, healthText, authResult, actionResult,
          submitAuth, toggleMode, logout, createDebate,
          loadDebates, loadCurrentUser,
          viewDebate, startDebate, pauseDebate, resumeDebate, stopDebate
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
